<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Booth Controls</title>
  <style>
    body { font-family: sans-serif; margin: 16px; }
    .row { margin: 8px 0; }
    label { display: inline-block; width: 200px; }
    input[type=range] { width: 300px; }
    button { padding: 8px 16px; }
    #wsRow { display: flex; gap: 8px; align-items: center; }
    #wsUrl { width: 360px; }
  </style>
</head>
<body>
  <h2>Booth Controls</h2>
  <div class="row" id="wsRow">
    <label>WebSocket URL</label>
    <input type="text" id="wsUrl" placeholder="ws://<BOOTH_IP>:8765" />
    <button id="connectBtn">Connect</button>
    <span id="status" style="margin-left:8px;color:#666;">disconnected</span>
  </div>
  <div class="row">
    <label>Detection Sensitivity</label>
    <input type="range" id="detection.sensitivity" min="0" max="1" step="0.01" value="0.6" />
  </div>
  <div class="row">
    <label>Effect Intensity</label>
    <input type="range" id="effect.intensity" min="0" max="1" step="0.01" value="0.85" />
  </div>
  <div class="row">
    <label>Hue Shift</label>
    <input type="range" id="effect.hue_shift" min="-1" max="1" step="0.01" value="0.0" />
  </div>
  <div class="row">
    <label>Trail</label>
    <input type="range" id="effect.trail" min="0" max="1" step="0.01" value="0.5" />
  </div>
  <div class="row">
    <label>Recording Duration (s)</label>
    <input type="range" id="recording.duration_s" min="5" max="25" step="1" value="12" />
  </div>
  <div class="row">
    <button id="recordBtn">Record</button>
  </div>
  <script>
    let ws;
    const wsUrlInput = document.getElementById('wsUrl');
    const statusEl = document.getElementById('status');
    const saved = localStorage.getItem('WS_URL');
    const defaultUrl = location.hostname ? `ws://${location.hostname}:8765` : 'ws://127.0.0.1:8765';
    wsUrlInput.value = saved || defaultUrl;

    function setStatus(text, color) {
      statusEl.textContent = text;
      statusEl.style.color = color || '#666';
    }

    function connect() {
      const WS_URL = wsUrlInput.value.trim();
      if (!WS_URL) return;
      try { if (ws) ws.close(); } catch {}
      setStatus('connecting...', '#a60');
      ws = new WebSocket(WS_URL);
      ws.onopen = () => setStatus('connected', '#0a0');
      ws.onclose = () => setStatus('disconnected', '#666');
      ws.onerror = () => setStatus('error', '#d00');
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'params') {
            for (const [k, v] of Object.entries(msg.data)) {
              const el = document.getElementById(k);
              if (el && el.type === 'range') el.value = v;
            }
          }
        } catch {}
      };
    }

    document.getElementById('connectBtn').addEventListener('click', () => {
      localStorage.setItem('WS_URL', wsUrlInput.value.trim());
      connect();
    });

    function sendSlider(id, value) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'slider', id, value: parseFloat(value) }));
    }

    document.querySelectorAll('input[type=range]').forEach(el => {
      el.addEventListener('input', e => sendSlider(e.target.id, e.target.value));
    });

    document.getElementById('recordBtn').addEventListener('click', () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'trigger', action: 'record' }));
    });

    // Auto-connect initially
    connect();
  </script>
</body>
</html>
